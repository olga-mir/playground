version: "3"

tasks:
  kind-create-sandbox:
    desc: "Create a vanilla Kind cluster (latest k8s, 2 nodes, name 'sandbox-cluster')"
    internal: true
    cmds:
      - |
        cat <<EOF | kind create cluster --name sandbox-cluster --config=-
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        nodes:
        - role: control-plane
        - role: worker
        EOF

  kind-delete-sandbox:
    desc: "Delete the 'sandbox-cluster' Kind cluster"
    internal: true
    cmds:
      - kind delete cluster --name sandbox-cluster

  crossplane-trace:
    desc: "Trace Crossplane resources"
    cmds:
      - crossplane beta trace valuestreamlandingzones -f "{{.TASKFILE_DIR}}/platform-tenants/team-alpha/landing-zone.yaml" -n team-alpha-tenant

  gke-cluster-status:
    desc: "Debug composed resources for a GKE cluster (usage: task debug-cluster CLUSTER=control-plane-cluster)"
    vars:
      CLUSTER: '{{default "control-plane-cluster" .CLUSTER}}'
      CONTEXT: '{{default "kind-kind-test-cluster" .CONTEXT}}'
    cmds:
      - kubectl --context={{.CONTEXT}} get nodepools.container.gcp-beta.upbound.io -o wide 2>/dev/null || echo "No nodepools found"
      - kubectl --context={{.CONTEXT}} get releases.helm.crossplane.io -o wide 2>/dev/null || echo "No helm releases found"
      - echo
      - kubectl --context={{.CONTEXT}} get clusters.container.gcp-beta.upbound.io -o wide 2>/dev/null || echo "No clusters found"
      - echo
      - kubectl --context={{.CONTEXT}} describe clusters.container.gcp-beta.upbound.io {{.CLUSTER}} | tail -5
      - echo
      - kubectl --context={{.CONTEXT}} get gkeclusters.platform.tornado-demo.io {{.CLUSTER}} -o wide
      - echo
      - kubectl --context={{.CONTEXT}} describe gkeclusters.platform.tornado-demo.io {{.CLUSTER}} | tail -5
      - echo

  crossplane-status:
    desc: "Debug Crossplane install (TODO - dynamic config)"
    vars:
      CLUSTER: '{{default "control-plane-cluster" .CLUSTER}}'
      CONTEXT: '{{default "kind-kind-test-cluster" .CONTEXT}}'
    cmds:
      - kubectl --context={{.CONTEXT}} get providerconfigs.kubernetes.crossplane.io -o wide 2>/dev/null || echo "No k8s provider configs found"
      - kubectl --context={{.CONTEXT}} get providers.pkg.crossplane.io -o wide 2>/dev/null || echo "No providers found"
      - kubectl --context={{.CONTEXT}} get providerconfigs.helm.crossplane.io -o wide 2>/dev/null || echo "No helm provider configs found"
      - kubectl --context={{.CONTEXT}} get pod -n crossplane-system 2>/dev/null || echo "No providers found"

  get-latest-flux-bootstrap-workflow-logs:
    desc: "Download logs from latest Flux Bootstrap workflow or provide URL if logs not available"
    cmds:
      - |
        RUN_ID=$(gh run list --workflow .github/workflows/flux-bootstrap.yml --limit 1 --json databaseId -q '.[0].databaseId')
        if gh run view $RUN_ID --log > ${RUN_ID}.txt 2>/dev/null; then
          echo "Downloaded logs from latest workflow run to ${RUN_ID}.txt"
        else
          echo "Logs not yet available for run $RUN_ID"
          JOB_ID=$(gh api repos/:owner/:repo/actions/runs/$RUN_ID/jobs --jq '.jobs[]|.id' | head -1)
          if [ -n "$JOB_ID" ]; then
            echo "View logs at: https://github.com/$(gh repo view --json owner,name -q '.owner.login + "/" + .name')/actions/runs/$RUN_ID/job/$JOB_ID"
          else
            echo "View run at: https://github.com/$(gh repo view --json owner,name -q '.owner.login + "/" + .name')/actions/runs/$RUN_ID"
          fi
        fi

  # task debug:trigger-flux-bootstrap-workflow CLUSTER=apps-dev
  trigger-flux-bootstrap-workflow:
    desc: "Manually trigger the Flux bootstrap workflow for debugging"
    vars:
      CLUSTER: '{{default "control-plane" .CLUSTER}}'
      LOCATION: '{{default "australia-southeast1-a" .LOCATION}}'
      IMMEDIATE: '{{default "true" .IMMEDIATE}}'
    cmds:
      - |
        gh api repos/:owner/:repo/dispatches -X POST \
          -f event_type=Kustomization/clusters.flux-system \
          -F client_payload[metadata][cluster]={{.CLUSTER}} \
          -F client_payload[metadata][location]={{.LOCATION}} \
          -F client_payload[metadata][immediate]={{.IMMEDIATE}} \
          -F 'client_payload[message]=Namespace/gkecluster-{{.CLUSTER}} created'
      - echo "Triggered Flux bootstrap workflow for {{.CLUSTER}} cluster (immediate={{.IMMEDIATE}})"

  helper-commands:
    desc: "Collection of troubleshooting commands"
    cmds:
      - echo "kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/experimental-install.yaml"
      - echo "helm template test oci://ghcr.io/kagent-dev/kagent/helm/kagent --namespace kagent --values test-values.yaml"
      - echo "while :; do flux get all -A && sleep 5; done"
      - echo "while :; do k get gkeclusters.platform.tornado-demo.io && kubectl --context=kind-kind-test-cluster describe gkeclusters.platform.tornado-demo.io control-plane-cluster | tail -2 && sleep 5; done"
      # re-trigger Composite Resource sync status
      - echo "kubectl --context kind-kind-test-cluster patch kustomization crossplane-composite-resources -n flux-system -p '{"spec":{"suspend":true}}' --type=merge"
      - echo "flux --context {{.CONTEXT}} suspend helmrelease kgateway -n kgateway-system"
      - echo "flux --context {{.CONTEXT}} resume helmrelease kgateway -n kgateway-system"
      - echo "gh api repos/:owner/:repo/dispatches -X POST -f event_type='Kustomization/clusters.flux-system'"
      - echo "gh run list --workflow .github/workflows/flux-bootstrap.yml --limit 1 --json databaseId -q '.[0].databaseId' --logs"
